<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Search Results</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
  header {
    background-color: black;
    color: white;
    height: 4rem;
    align-items: center;
    display: flex;
    padding: 1rem;
  }
  * {
    padding: 0;
    margin: 0;
    outline: none;
  }
  .containerall {
    display: flex;
  }
  .search_container {
    min-width: 20vw;
    padding: 1rem;
  }
  .img_container {
    min-width: 80vw;
  }
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem 0;
  }
  .carousel-item img {
    width: 100%;
    height: auto;
  }
  .image-grid {
    display: flex;
    flex-wrap: wrap;
  }
  .image-grid img {
    margin: 10px;
    max-width: 120px;
    max-height: 200px;
    transition: 1s;
    cursor: pointer;
  }
  .image-grid img:hover {
    margin: 10px;
    max-width: 350px;
    max-height: 420px;
    cursor: pointer;
  }
  .page-link {
    color: white;
    background: black;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
  }

  .search_complex {
    position: fixed;
  }
  
  button {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.25rem;
    border: none;
    border-radius: 10px;
    fill: white;
    transition: background-color 0.3s;
    height: 3rem;
    width: 16.5rem;
  }
  #search_btn {
    background: #343A40;
    color: white;
  }
  .toolbar {
    width: 16.5rem;
    padding: 1rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }
  .mlt-search {
    display: flex;
    gap: 0.5rem;
    list-style-type: none;
    border-bottom: 1px solid black;
    padding-bottom: 0.5rem;
  }
  .mlt-search li {
    margin: 5px 0;
    padding: 5px;
    cursor: pointer;
    color: gray;
  }
  li.selected {
    fill: blue;
  }
  #textInput {
    border: none;
    border-bottom: 1px solid black;
  }
  .checkbox-item {
    margin: 0.5rem 0;
    cursor: pointer;
  }

  #helpButton {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #343A40;
      color: white; 
      font-size: 24px;
      border: none;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
  }

  #modalBox {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      height: 500px;  
      padding: 20px;
      background-color: white;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      z-index: 1000;
  }

  #closeButton {
      position: absolute;
      top: 10px;
      width: 10px;
      height: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
  }

  #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
  }

  #brushSize {
    width: 150px;
    cursor: pointer;
  }

  .toolbar_object {
    display: flex;
    background-color: #343A40;
    border-radius: 12px;
    padding: 1rem;
    gap: 2rem;
  }
  .toolbar_object svg {
    width: 30px;
    height: 30px;
    fill: white;
    cursor: pointer;
  }
  .canvas-container {
    width: 300px;
    margin-top: 1rem;
    position: relative;
    border-radius: 5px;
    background-color: white;
  }

  canvas {
    display: block;
    background-color: white;
    border: 2px solid #343A40;
    width: 300px;
    height: 300px;
  }
</style>
<body>
  <header>
    <h3>HCM AI CHALLENGE 2023 - <b> Event Retrieval from Visual Data </b></h3>
  </header>
  <section class="containerall">
    <div class="search_container">
      <div class="search_complex">
        <button id="search_btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 0 24 24" id="search">
            <g><path d="m20.71 19.29-3.4-3.39A7.92 7.92 0 0 0 19 11a8 8 0 1 0-8 8 7.92 7.92 0 0 0 4.9-1.69l3.39 3.4a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42zM5 11a6 6 0 1 1 6 6 6 6 0 0 1-6-6z"></path></g>
          </svg> Search
        </button>
        <div class="toolbar">
          <ul class="mlt-search">
            <li id="text">
              <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 18 16" id="text">
                <path d="M13.62 9.08L12.1 3.66h-.06l-1.5 5.42h3.08zM5.7 10.13S4.68 6.52 4.53 6.02h-.08l-1.13 4.11H5.7zM17.31 14h-2.25l-.95-3.25h-4.07L9.09 14H6.84l-.69-2.33H2.87L2.17 14H0l3.3-9.59h2.5l2.17 6.34L10.86 2h2.52l3.94 12h-.01z"></path>
              </svg>
            </li>
            <li id="object">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" id="object">
                <path d="M5.072 0A5.061 5.061 0 0 0 0 5.072v13.856A5.061 5.061 0 0 0 5.072 24h13.856A5.061 5.061 0 0 0 24 18.928V5.072A5.061 5.061 0 0 0 18.928 0H5.072zM6 5h7v3H6V5zm8 0h5v6h-5V5zm-8 6h7v8H6v-8zm8 1h5v4h-5v-4z"></path>
              </svg>
            </li>
          </ul>
          <div class="textRelated">
            Categories:<br>
            <input class="checkbox-item" type="checkbox" id="OCR"> Text on Screen (OCR)<br>
            <input class="checkbox-item" type="checkbox" id="ASR"> Audio (ASR)<br>
            <input class="checkbox-item" type="checkbox" id="Clip"> Text Embedding (Clip)<br>
            Search text:
            <input type="text" id="textInput">
          </div>
        </div>
      </div>
    </div>
    <div class="img_container">
      <div id="imageCarousel" class="carousel slide" data-ride="carousel">
          <div class="carousel-inner">
              <!-- Display images in a grid layout -->
              <div class="carousel-item active">
                  <div class="image-grid">
                      {% for item in data %}
                          <div>
                              <img src="{{ item.imgpath }}" alt="Image {{ item.id }}" class="carousel-image">
                          </div>
                      {% endfor %}
                  </div>
              </div>
          </div>
      </div>
      <nav aria-label="Page navigation example">
          <ul class="pagination justify-content-center mt-4">
              <!-- First and Previous buttons -->
              {% if page > 1 %}
                  <li class="page-item"><a class="page-link" id="firstPage" href="?page=1{% if query %}&query={{ query }}{% endif %}">First</a></li>
                  <li class="page-item"><a class="page-link" id="prevPage" href="?page={{ page - 1 }}{% if query %}&query={{ query }}{% endif %}">Previous</a></li>
              {% else %}
                  <li class="page-item disabled"><a class="page-link">First</a></li>
                  <li class="page-item disabled"><a class="page-link">Previous</a></li>
              {% endif %}

              <!-- Current page indicator -->
              <li class="page-item disabled"><a class="page-link">Page {{ page }} of {{ num_pages }}</a></li>

              <!-- Next and Last buttons -->
              {% if page < num_pages %}
                  <li class="page-item"><a class="page-link" id="nextPage" href="?page={{ page + 1 }}{% if query %}&query={{ query }}{% endif %}">Next</a></li>
                  <li class="page-item"><a class="page-link" id="lastPage" href="?page={{ num_pages }}{% if query %}&query={{ query }}{% endif %}">Last</a></li>
              {% else %}
                  <li class="page-item disabled"><a class="page-link">Next</a></li>
                  <li class="page-item disabled"><a class="page-link">Last</a></li>
              {% endif %}
          </ul>
      </nav>
      <button id="helpButton">?</button>
      <div id="overlay"></div>

      <div id="modalBox">
          <button id="closeButton">&times;</button>
          <div class="slide-1">
            <h2><b>Shortcut</b></h2>
            <p>press <b>"1"</b> for OCR (text on screen)<br>press <b>"2"</b> for ASR (audio)<br>press <b>"3"</b> for Clip (text embedding)<br>press <b>"Enter"</b> to search</p>
            <h2><b>Bugs and ignore it ðŸ’©</b></h2>
            <p>You close the popup without stopping the video. It will still run in the background</p>
            <p>When you type in "search text", if you press "1","2", or "3", it will detect as a shortcut and change checkboxes' status </p>
            <p>:D</p>
          </div>
          <div class="slide-2"></div>
          <div class="slide-3">
            <div class="toolbar_object">
              <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"  xml:space="preserve"><style type="text/css"></style><g><path class="st0" d="M141.176,324.641l25.323,17.833c7.788,5.492,17.501,7.537,26.85,5.67c9.35-1.877,17.518-7.514,22.597-15.569l22.985-36.556l-78.377-55.222l-26.681,33.96c-5.887,7.489-8.443,17.081-7.076,26.511C128.188,310.69,133.388,319.158,141.176,324.641z"/><path class="st0" d="M384.289,64.9c9.527-15.14,5.524-35.06-9.083-45.355l-0.194-0.129c-14.615-10.296-34.728-7.344-45.776,6.705L170.041,228.722l77.067,54.292L384.289,64.9z"/><path class="st0" d="M504.745,445.939c-4.011,0-7.254,3.251-7.254,7.262s3.243,7.246,7.254,7.246c4.012,0,7.255-3.235,7.255-7.246S508.757,445.939,504.745,445.939z"/><path class="st0" d="M457.425,432.594c3.914,0,7.092-3.179,7.092-7.101c0-3.898-3.178-7.077-7.092-7.077c-3.915,0-7.093,3.178-7.093,7.077C450.332,429.415,453.51,432.594,457.425,432.594z"/><path class="st0" d="M164.493,440.972c14.671-20.817,16.951-48.064,5.969-71.089l-0.462-0.97l-54.898-38.675l-1.059-0.105c-25.379-2.596-50.256,8.726-64.928,29.552c-13.91,19.742-18.965,41.288-23.858,62.113c-3.333,14.218-6.778,28.929-13.037,43.05c-5.168,11.695-8.63,15.868-8.654,15.884L0,484.759l4.852,2.346c22.613,10.902,53.152,12.406,83.779,4.156C120.812,482.584,147.76,464.717,164.493,440.972z M136.146,446.504c-0.849,0.567-1.714,1.19-2.629,1.892c-10.06,7.91-23.17,4.505-15.188-11.54c7.966-16.054-6.09-21.198-17.502-10.652c-14.323,13.232-21.044,2.669-18.391-4.634c2.636-7.304,12.155-17.267,4.189-23.704c-4.788-3.882-10.967,1.795-20.833,9.486c-5.645,4.392-18.666,2.968-13.393-16.563c2.863-7.271,6.389-14.275,11.104-20.971c10.24-14.542,27.603-23.083,45.404-22.403l47.021,33.11c6.632,16.548,4.416,35.764-5.823,50.305C146.167,436.411,141.476,441.676,136.146,446.504z"/><path class="st0" d="M471.764,441.992H339.549c-0.227-0.477-0.38-1.003-0.38-1.57c0-0.913,0.372-1.73,0.93-2.378h81.531c5.848,0,10.578-4.723,10.578-10.578c0-5.84-4.73-10.571-10.578-10.571H197.765c0.308,15.399-4.116,30.79-13.271,43.786c-11.218,15.925-27.214,28.913-46.196,38.036h303.802c6.551,0,11.864-5.314,11.864-11.872c0-6.559-5.314-11.873-11.864-11.873h-55.392c-3.299,0-5.977-2.668-5.977-5.968c0-1.246,0.47-2.313,1.1-3.267h89.934c6.559,0,11.881-5.305,11.881-11.873C483.645,447.306,478.323,441.992,471.764,441.992z"/></g></svg>
              <input type="range" id="brushSize" min="20" max="100" value="5">
              <svg xmlns="http://www.w3.org/2000/svg" id="clearCanvas" viewBox="0 0 128 128"><path d="M 49 1 C 47.34 1 46 2.34 46 4 C 46 5.66 47.34 7 49 7 L 79 7 C 80.66 7 82 5.66 82 4 C 82 2.34 80.66 1 79 1 L 49 1 z M 24 15 C 16.83 15 11 20.83 11 28 C 11 35.17 16.83 41 24 41 L 101 41 L 101 104 C 101 113.37 93.37 121 84 121 L 44 121 C 34.63 121 27 113.37 27 104 L 27 52 C 27 50.34 25.66 49 24 49 C 22.34 49 21 50.34 21 52 L 21 104 C 21 116.68 31.32 127 44 127 L 84 127 C 96.68 127 107 116.68 107 104 L 107 40.640625 C 112.72 39.280625 117 34.14 117 28 C 117 20.83 111.17 15 104 15 L 24 15 z M 24 21 L 104 21 C 107.86 21 111 24.14 111 28 C 111 31.86 107.86 35 104 35 L 24 35 C 20.14 35 17 31.86 17 28 C 17 24.14 20.14 21 24 21 z M 50 55 C 48.34 55 47 56.34 47 58 L 47 104 C 47 105.66 48.34 107 50 107 C 51.66 107 53 105.66 53 104 L 53 58 C 53 56.34 51.66 55 50 55 z M 78 55 C 76.34 55 75 56.34 75 58 L 75 104 C 75 105.66 76.34 107 78 107 C 79.66 107 81 105.66 81 104 L 81 58 C 81 56.34 79.66 55 78 55 z"></path></svg>
            </div>
            <div>
              <div class="canvas-container">
                <canvas id="drawingCanvas"></canvas>
              </div>
              <div class="">

              </div>
            </div>
          </div>
      </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script type="text/javascript">
    function hideSearch() {
        document.querySelector('.textRelated').style.display = 'none';
    }
    hideSearch();
    const textSearch  = document.querySelector(".textRelated");
    const checkboxes = document.querySelectorAll('.checkbox-item');
    const searchBtn = document.getElementById("search_btn");
    
    function handleCheckboxChange(changedCheckbox) {
        checkboxes.forEach(checkbox => {
            if (checkbox !== changedCheckbox) {
                checkbox.checked = false;
            }
        });
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                handleCheckboxChange(this);
            }
        });
    });

    document.querySelectorAll('.mlt-search li').forEach(function(li) {
        li.addEventListener('click', function() {
            hideSearch();
            document.querySelectorAll('.mlt-search li').forEach(function(item) {
                item.classList.remove('selected');
            }); 
            li.classList.add('selected');
            if (li.id === 'text') {
              textSearch.style.display = 'block';
            }
            if (li.id === 'object') {
              showModalObjectSearch();
            }
        });
    });
    
    searchBtn.addEventListener('click', function() {
      const searchElement = document.querySelector('#textInput');
      const searchText = searchElement.value;
      if (searchText && searchText != "") {
        if (document.getElementById('OCR').checked) {
          const url = new URL('/ocr', window.location.origin);
          url.searchParams.set('page', 1); 
          url.searchParams.set('query', searchText); 
          window.location.href = url.toString(); 
        } else if (document.getElementById('ASR').checked) {
          const url = new URL('/asr', window.location.origin);
          url.searchParams.set('page', 1); 
          url.searchParams.set('query', searchText); 
          window.location.href = url.toString(); 
        } else if (document.getElementById('Clip').checked) {
          const url = new URL('/clip', window.location.origin);
          url.searchParams.set('page', 1); 
          url.searchParams.set('query', searchText); 
          window.location.href = url.toString(); 
        } else {
          alert("Please select at least one search option.");
        }
      } else {
        alert("Please type the search text")
      }
    });
    
    //object search
    function showModalObjectSearch(src) {
      hideSlide()
      modalBox.style.display = 'block';
      overlay.style.display = 'block';
      slide3.style.display = 'block';
    }


    //help button and image interactions
    const helpButton = document.getElementById('helpButton');
    const modalBox = document.getElementById('modalBox');
    const closeButton = document.getElementById('closeButton');
    const slide1 = document.querySelector('.slide-1');
    const slide2 = document.querySelector('.slide-2');
    const slide3 = document.querySelector('.slide-3');
    const overlay = document.getElementById('overlay');
    const carouselimg = document.querySelectorAll(".carousel-image");
    let jsonData = {}; 
    
    fetch('../data/path_video.json')
    .then(response => response.json())
    .then(data => {
        jsonData = data;
    })
    .catch(error => {
        alert('Error loading the JSON file, reload the page to fix:', error);
    });

    function getYouTubeVideoId(url) {
        const regex = /[?&]v=([^&#]*)/;
        const match = url.match(regex);
        return match ? match[1] : null;
    }
    
    function convertFrameToSeconds(frameNumber, fps = 30) {
      return parseInt(frameNumber.replace("frame_",""), 10) / fps;
    }

    function hideSlide() {
      slide3.style.display = 'none';
      slide2.style.display = 'none';
      slide1.style.display = 'none';
    }

    function showModal(src) {
      hideSlide()
      modalBox.style.display = 'block';
      overlay.style.display = 'block';
      slide2.style.display = 'block';
      const imgpath = src.split("/");
      const video_url = jsonData[imgpath[imgpath.length-2]];
      const videoId = getYouTubeVideoId(video_url);
      const frameId = imgpath[imgpath.length-1].replace(".png","")
      const seconds = convertFrameToSeconds(frameId);
      slide2.innerHTML = `
      <h2>Frame information</h2>
      <p><b>url</b>: <a target="_blank" href="https://www.youtube.com/watch?v=${videoId}&t=${Math.floor(seconds)}s">https://www.youtube.com/watch?v=${videoId}&t=${Math.floor(seconds)}s<a><br><b>frame_id</b>: ${frameId}</p>
      <iframe id="player" width="100%" height="300px" src="https://www.youtube-nocookie.com/embed/${videoId}?start=${Math.floor(seconds)}&autoplay=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`
      ;
    }
    
    carouselimg.forEach(img => {
        img.addEventListener("click", function() {
            showModal(this.src)
        });
    });

    helpButton.addEventListener('click', () => {
        hideSlide();
        modalBox.style.display = 'block';
        overlay.style.display = 'block';
        slide1.style.display = 'block';
    });

    closeButton.addEventListener('click', () => {
        modalBox.style.display = 'none';
        overlay.style.display = 'none';
        document.getElementById("player").stopVideo();
    });

    overlay.addEventListener('click', () => {
        modalBox.style.display = 'none';
        overlay.style.display = 'none';
    });


    //Draw function
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const brushSize = document.getElementById('brushSize');
    const clearCanvas = document.getElementById('clearCanvas'); 
    canvas.width = 300;
    canvas.height = 300;
    let drawing = false;
    let brushColor = '#000000';
    let brushRadius = 20;
    brushSize.addEventListener('input', (e) => {
        brushRadius = e.target.value;
    });
    function startDrawing(e) {
        drawing = true;
        draw(e);
    }
    function stopDrawing() {
        drawing = false;
        ctx.beginPath();
    }
    function draw(e) {
      if (!drawing) return;
      ctx.lineWidth = brushRadius;
      ctx.lineCap = 'round';  
      ctx.strokeStyle = brushColor;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    clearCanvas.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);  
    canvas.addEventListener('mousemove', draw);

    // Shortcut 
    document.addEventListener("keyup", function(event) {
        if (event.key === "1") {
            event.preventDefault();
            document.getElementById("text").click();
            document.getElementById("textInput").focus();
            ocrcheck = document.getElementById("OCR");
            handleCheckboxChange(ocrcheck);
            ocrcheck.checked = true;
        }
        if (event.key === "2") {
            event.preventDefault();
            document.getElementById("text").click();
            document.getElementById("textInput").focus();
            asrcheck = document.getElementById("ASR");
            handleCheckboxChange(asrcheck);
            asrcheck.checked = true;
          }
        if (event.key === "3") {
            event.preventDefault();
            document.getElementById("text").click();
            clipcheck = document.getElementById("Clip");
            handleCheckboxChange(clipcheck);
            clipcheck.checked = true;
            document.getElementById("textInput").focus();
        }
        if (event.key === "Enter") {
            event.preventDefault();
            searchBtn.click();
        }
        if (event.key === "Escape") {
            event.preventDefault();
            modalBox.style.display = 'none';
            overlay.style.display = 'none';
        }
    });
  </script>
  
</body>
</html>
